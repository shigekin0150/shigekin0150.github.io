<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Salesforce 模擬問題</title>

<style>
body { font-family: system-ui; margin:0; background:#f6f7f9; }
.container { max-width: 900px; margin:auto; padding:20px; }

.topbar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

select {
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #ccc;
}

.question-card {
  background:#fff;
  border-radius:12px;
  padding:15px;
  margin:15px 0;
  border:1px solid #ddd;
}

.question-title { font-weight:700; margin-bottom:10px; }

.choice-item {
  margin:6px 0;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
  border:1px solid #ddd;
}

.choice-item.selected {
  background:#e3f2fd;
  border-color:#1976d2;
}

button {
  margin-top:10px;
  padding:6px 12px;
  border:none;
  border-radius:6px;
  background:#1976d2;
  color:white;
  cursor:pointer;
}

.feedback {
  margin-top:10px;
  padding:10px;
  border-radius:8px;
  background:#f1f1f1;
  display:none;
}

.correct { color:green; font-weight:bold; }
.incorrect { color:red; font-weight:bold; }

</style>
</head>
<body>

<div class="container">

<div class="topbar">
  <h1>Salesforce 模擬問題</h1>

  <!-- 資格切り替え -->
  <select id="exam-select">
    <option value="sharing">Sharing & Visibility</option>
    <option value="pd1">Platform Developer I（将来）</option>
  </select>
</div>

<div id="question-list"></div>

</div>

<script>

const examFiles = {
  sharing: "data/sharing_and_visibility_exams.json",
  pd1: "data/pd1_exams.json"
};

let currentQuestions = [];

document.addEventListener("DOMContentLoaded", () => {
  loadExam("sharing");

  document.getElementById("exam-select").addEventListener("change", (e) => {
    loadExam(e.target.value);
  });
});

async function loadExam(key) {
  const file = examFiles[key];

  try {
    const res = await fetch(file, { cache: "no-store" });
    const raw = await res.json();
    currentQuestions = extractQuestions(raw);
    renderQuestions(currentQuestions);
  } catch (e) {
    document.getElementById("question-list").innerHTML =
      "<p>問題ファイルがまだ存在しません。</p>";
  }
}

function extractQuestions(raw) {
  let merged = [];

  if (Array.isArray(raw)) {
    raw.forEach(item => {
      if (item.questions) merged.push(...item.questions);
    });
    if (raw.length && raw[0]?.question_ja) merged = raw;
  } else if (raw.questions) {
    merged = raw.questions;
  }

  return merged.filter(q => q && q.question_ja);
}

function renderQuestions(questions) {
  const container = document.getElementById("question-list");
  container.innerHTML = "";

  questions.forEach((q, index) => {

    const card = document.createElement("div");
    card.className = "question-card";

    const title = document.createElement("div");
    title.className = "question-title";
    title.textContent = `Q${q.question_no ?? index+1}. ${q.question_ja}`;
    card.appendChild(title);

    const selected = [];
    const isMultiple = (q.correct_answers || []).length > 1;

    Object.entries(q.choices_ja || {}).forEach(([key, value]) => {

      const item = document.createElement("div");
      item.className = "choice-item";
      item.textContent = `${key}: ${value}`;

      item.onclick = () => {

        if (!isMultiple) {
          selected.length = 0;
          card.querySelectorAll(".choice-item")
              .forEach(el => el.classList.remove("selected"));
        }

        if (selected.includes(key)) {
          selected.splice(selected.indexOf(key),1);
          item.classList.remove("selected");
        } else {
          selected.push(key);
          item.classList.add("selected");
        }
      };

      card.appendChild(item);
    });

    const button = document.createElement("button");
    button.textContent = "答えを見る";
    card.appendChild(button);

    const feedback = document.createElement("div");
    feedback.className = "feedback";
    card.appendChild(feedback);

    button.onclick = () => {

      if (selected.length === 0) {
        alert("回答を選択してください");
        return;
      }

      const correct = (q.correct_answers || []).slice().sort().join(",");
      const user = selected.slice().sort().join(",");

      feedback.style.display = "block";

      if (correct === user) {
        feedback.innerHTML = `<div class="correct">✅ 正解</div>`;
      } else {
        feedback.innerHTML = `<div class="incorrect">❌ 不正解</div>`;
      }

      feedback.innerHTML += `<div>あなた: ${user}</div>`;
      feedback.innerHTML += `<div>正解: ${correct}</div>`;
      feedback.innerHTML += `<div style="margin-top:8px;">${q.explanation_ja || ""}</div>`;

      button.disabled = true;
      button.textContent = "確認済み";
    };

    container.appendChild(card);
  });
}

</script>

</body>
</html>
